<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Vida Saludable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1f8f6b">
  <link rel="apple-touch-icon" href="icon-192.png">
</head>
<body>

<img src="https://images.unsplash.com/photo-1498837167922-ddd27525d352" class="header-image">

<h1>ðŸ¥— Vida Saludable</h1>
<div style="display:flex; justify-content:center; align-items:center; gap:14px; margin-bottom:15px;">

  <button id="prevDay" style="
    background:white;
    border:none;
    border-radius:50%;
    width:36px;
    height:36px;
    font-size:18px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    cursor:pointer;
  ">â—€</button>

  <div id="displayDate" style="
    font-weight:600;
    font-size:16px;
    color:#1f5c45;
    cursor:pointer;
  "></div>

  <button id="nextDay" style="
    background:white;
    border:none;
    border-radius:50%;
    width:36px;
    height:36px;
    font-size:18px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    cursor:pointer;
  ">â–¶</button>

  <!-- Calendario oculto pero funcional -->
  <input type="date" id="datePicker" style="display:none;">

</div>

<div style="
  background:white;
  margin:12px;
  padding:14px;
  border-radius:18px;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
">
  <h3 style="margin-bottom:10px; font-size:14px; color:#1f5c45;">
    ðŸ“Š Ãšltimos 7 dÃ­as
  </h3>
  <canvas id="weeklyChart" height="120"></canvas>
</div>



<div id="meals"></div>

<!-- ===== RESUMEN FIJO ===== -->
<div class="summary">
  <h3>
    Meta diaria:
    <input type="number" id="goal" class="goal-input" value="2000">
    kcal
  </h3>

  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <p><strong id="totalKcal">0</strong> kcal consumidas</p>
  <p>
    C: <span id="totalCarbs">0</span>g |
    P: <span id="totalProtein">0</span>g |
    G: <span id="totalFat">0</span>g
  </p>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

const foods = {
  "Fruta": { carbs: 15, protein: 0, fat: 0, kcal: 60, color: "#f39c12", icon: "ðŸŽ" },
  "Vegetal": { carbs: 5, protein: 2, fat: 0, kcal: 25, color: "#27ae60", icon: "ðŸ¥¦" },
  "Carbohidrato": { carbs: 5, protein: 2, fat: 0, kcal: 25, color: "#f1c40f", icon: "ðŸš" },
  "ProteÃ­na Magra": { carbs: 0, protein: 7, fat: 2, kcal: 45, color: "#3498db", icon: "ðŸ”" },
  "ProteÃ­na Media": { carbs: 0, protein: 7, fat: 5, kcal: 75, color: "#2980b9", icon: "ðŸ¥©" },
  "Grasa": { carbs: 0, protein: 0, fat: 5, kcal: 45, color: "#e67e22", icon: "ðŸ¥‘" },
  "Fruto Seco": { carbs: 7, protein: 5, fat: 15, kcal: 180, color: "#8e6e53", icon: "ðŸ¥œ" },
  "LÃ¡cteo": { carbs: 12, protein: 8, fat: 2, kcal: 100, color: "#9b59b6", icon: "ðŸ¥›" }
};

const mealNames = [
  "Preentreno",
  "Desayuno",
  "Merienda MaÃ±ana",
  "Almuerzo",
  "Merienda Tarde",
  "Cena"
];

let allData = JSON.parse(localStorage.getItem("calorieApp")) || {};
let currentDate = "";
let data = {};

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString("es-ES", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
}

function initDate() {
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("datePicker").value = today;
  changeDate(today);
}

function changeDate(date) {
  document.getElementById("datePicker").value = date;
  document.getElementById("displayDate").innerText = formatDate(date);
  loadDate(date);
}


function loadDate(date) {

  currentDate = date;

  if (!allData[currentDate]) {
    allData[currentDate] = {
      goal: 2000,
      meals: {}
    };
  }

  data = allData[currentDate].meals;

  createMeals();
  update();
}

function saveData() {
  allData[currentDate].goal = document.getElementById("goal").value;
  allData[currentDate].meals = data;
  localStorage.setItem("calorieApp", JSON.stringify(allData));
}

function createMeals() {

  const container = document.getElementById("meals");
  container.innerHTML = "";

  mealNames.forEach(meal => {

    if (!data[meal]) data[meal] = {};

    let mealDiv = document.createElement("div");
    mealDiv.className = "meal";

    let header = document.createElement("div");
    header.className = "meal-header";
    header.innerHTML = `
      ${meal}
      <span id="kcal-${meal}">0 kcal</span>
    `;

    header.onclick = () => {
      mealDiv.classList.toggle("active");
    };

    let content = document.createElement("div");
    content.className = "meal-content";

    for (let food in foods) {

      if (!data[meal][food]) data[meal][food] = 0;

      let item = document.createElement("div");
      item.className = "macro-item";

      item.innerHTML = `
        <span style="color:${foods[food].color}; font-weight:500;">
          ${foods[food].icon} ${food}
        </span>
        <div class="controls">
          <button class="minus">-</button>
          <span class="count" id="${meal}-${food}">0</span>
          <button class="plus">+</button>
        </div>
      `;

      item.querySelector(".minus").onclick = () => {
        if (data[meal][food] > 0) {
          data[meal][food]--;
          update();
        }
      };

      item.querySelector(".plus").onclick = () => {
        data[meal][food]++;
        update();
      };

      content.appendChild(item);
    }

    mealDiv.appendChild(header);
    mealDiv.appendChild(content);
    container.appendChild(mealDiv);

  });

  document.getElementById("goal").value = allData[currentDate].goal;
}

let chart;

function updateWeeklyChart() {

  let labels = [];
  let values = [];

  for (let i = 6; i >= 0; i--) {

    let date = new Date();
    date.setDate(date.getDate() - i);

    let dateKey = date.toISOString().split("T")[0];
    let formatted = date.toLocaleDateString("es-ES", { day: "2-digit", month: "short" });

    labels.push(formatted);

    if (allData[dateKey]) {

      let dayMeals = allData[dateKey].meals;
      let dayTotal = 0;

      for (let meal in dayMeals) {
        for (let food in dayMeals[meal]) {
          dayTotal += dayMeals[meal][food] * foods[food].kcal;
        }
      }

      values.push(dayTotal);

    } else {
      values.push(0);
    }
  }

  if (chart) chart.destroy();

  const ctx = document.getElementById("weeklyChart").getContext("2d");

  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        data: values,
        borderRadius: 12,
        borderSkipped: false
      }]
    },
    options: {
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { display: false }
        },
        x: {
          grid: { display: false }
        }
      }
    }
  });
}


function update() {

  let totalCarbs = 0;
  let totalProtein = 0;
  let totalFat = 0;
  let totalKcal = 0;

  mealNames.forEach(meal => {

    let mealKcal = 0;

    for (let food in foods) {

      let count = data[meal][food] || 0;
      document.getElementById(`${meal}-${food}`).innerText = count;

      totalCarbs += count * foods[food].carbs;
      totalProtein += count * foods[food].protein;
      totalFat += count * foods[food].fat;
      totalKcal += count * foods[food].kcal;
      mealKcal += count * foods[food].kcal;
    }

    document.getElementById(`kcal-${meal}`).innerText = mealKcal + " kcal";
  });

  document.getElementById("totalCarbs").innerText = totalCarbs;
  document.getElementById("totalProtein").innerText = totalProtein;
  document.getElementById("totalFat").innerText = totalFat;
  document.getElementById("totalKcal").innerText = totalKcal;

  let goal = document.getElementById("goal").value;
  let percent = (totalKcal / goal) * 100;
  if (percent > 100) percent = 100;

  document.getElementById("progressBar").style.width = percent + "%";

  saveData();
  updateWeeklyChart();
}

document.getElementById("goal").addEventListener("input", update);
document.getElementById("prevDay").addEventListener("click", () => {
  let current = new Date(document.getElementById("datePicker").value);
  current.setDate(current.getDate() - 1);
  let newDate = current.toISOString().split("T")[0];
  changeDate(newDate);
});

document.getElementById("nextDay").addEventListener("click", () => {
  let current = new Date(document.getElementById("datePicker").value);
  current.setDate(current.getDate() + 1);
  let newDate = current.toISOString().split("T")[0];
  changeDate(newDate);
});

// Al tocar la fecha abre el calendario
document.getElementById("displayDate").addEventListener("click", () => {
  document.getElementById("datePicker").showPicker();
});

// Si se cambia desde el calendario
document.getElementById("datePicker").addEventListener("change", (e) => {
  changeDate(e.target.value);
});

initDate();

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}

</script>

</body>
</html>
